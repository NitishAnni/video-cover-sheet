<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Candidate Video Submission</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      width: 95%;
      background-color: #fff;
      padding: 30px;
      margin: 30px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    h2 {
      color: #d6336c;
      text-align: center;
    }
    button {
      margin: 5px 5px 10px 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    video {
      display: block;
      margin: 10px 0;
      max-width: 100%;
    }
    .question {
      margin-bottom: 15px;
      font-weight: bold;
    }
    label {
      display: block;
      margin: 10px 0;
      font-weight: 500;
    }
    input {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
  </style>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function(){
      emailjs.init("_rmD1hNEDk-sVx2TQ"); // your public key
      console.log("‚úÖ EmailJS initialized");
    })();
  </script>
</head>
<body>
  <div class="container">
    <h2>Candidate Video Submission</h2>

    <div class="questions">
      <div class="question">1. Introduce yourself.</div>
      <div class="question">2. Why are you interested in this role?</div>
      <div class="question">3. What are your key skills relevant to this job?</div>
      <div class="question">4. Any final message to us?</div>
    </div>

    <label>Name:
      <input type="text" id="candidateName" placeholder="Enter your full name">
    </label>
    <label>Email:
      <input type="email" id="candidateEmail" placeholder="Enter your email address">
    </label>

    <div>
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop Recording</button>
    </div>

    <video id="preview" controls></video>

    <div>
      <button id="reRecordBtn" disabled>Re-record</button>
      <button id="uploadBtn" disabled>Proceed & Upload</button>
    </div>

    <div id="status"></div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.6.0/dist/umd/supabase.min.js"></script>
    <script>
      console.log("‚úÖ Script loaded");

      // ===== Supabase Config =====
      const SUPABASE_URL = "https://rxwdqmfeeknxshbydsne.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4d2RxbWZlZWtueHNoYnlkc25lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNDMyNTksImV4cCI6MjA3MzcxOTI1OX0.sP8DJzwLrC4tJ8JJjVhBUKitVsXsiNFYnsj0jLdlD2U";
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const bucketName = "video_cover_sheet";

      let mediaRecorder;
      let recordedChunks = [];
      let stream;

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const reRecordBtn = document.getElementById("reRecordBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const preview = document.getElementById("preview");
      const status = document.getElementById("status");

      startBtn.addEventListener("click", async () => {
        console.log("‚ñ∂Ô∏è Start button clicked");
        const candidateName = document.getElementById("candidateName").value.trim();
        const candidateEmail = document.getElementById("candidateEmail").value.trim();
        if (!candidateName || !candidateEmail) {
          alert("Please enter both name and email.");
          console.warn("‚ö†Ô∏è Missing name or email");
          return;
        }

        try {
          console.log("Requesting camera + mic...");
          stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
            audio: true
          });
          console.log("‚úÖ Got media stream:", stream);

          preview.srcObject = stream;
          preview.muted = true;

          await preview.play()
            .then(() => console.log("üé• Preview playing"))
            .catch(err => console.error("‚ùå Preview play error:", err));

          recordedChunks = [];
          mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm;codecs=vp9,opus" });
          console.log("‚úÖ MediaRecorder created:", mediaRecorder);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
              recordedChunks.push(e.data);
              console.log("üì¶ Data chunk size:", e.data.size);
            }
          };

          mediaRecorder.onstop = () => {
            console.log("‚èπÔ∏è MediaRecorder stopped");
            const blob = new Blob(recordedChunks, { type: "video/webm" });
            preview.srcObject = null;
            preview.src = URL.createObjectURL(blob);
            preview.muted = false;
            preview.controls = true;

            reRecordBtn.disabled = false;
            uploadBtn.disabled = false;
            status.textContent = "Recording complete. Preview your video.";
          };

          mediaRecorder.start();
          console.log("‚ñ∂Ô∏è MediaRecorder started");
          status.textContent = "Recording...";

          startBtn.disabled = true;
          stopBtn.disabled = false;
          reRecordBtn.disabled = true;
          uploadBtn.disabled = true;

          // Auto-stop after 8 mins
          setTimeout(() => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
              console.log("‚è∞ Auto stop after 8 minutes");
              stopRecording();
            }
          }, 480000);

        } catch (err) {
          console.error("‚ùå getUserMedia failed:", err.name, err.message, err);
          alert("Camera/Mic access failed: " + err.message);
        }
      });

      stopBtn.addEventListener("click", () => {
        console.log("üõë Stop button clicked");
        stopRecording();
      });

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          console.log("‚úÖ Recording stopped by user");
        }
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          console.log("‚úÖ Media tracks stopped");
        }
        stopBtn.disabled = true;
      }

      reRecordBtn.addEventListener("click", () => {
        console.log("üîÑ Re-record clicked");
        preview.src = "";
        recordedChunks = [];
        startBtn.disabled = false;
        stopBtn.disabled = true;
        reRecordBtn.disabled = true;
        uploadBtn.disabled = true;
        status.textContent = "Ready to re-record.";
      });

      uploadBtn.addEventListener("click", async () => {
        console.log("‚¨ÜÔ∏è Upload clicked");
        const candidateName = document.getElementById("candidateName").value.trim();
        const candidateEmail = document.getElementById("candidateEmail").value.trim();
        if (!candidateName || !candidateEmail) {
          alert("Enter both name and email.");
          console.warn("‚ö†Ô∏è Missing name/email on upload");
          return;
        }

        uploadBtn.disabled = true;
        reRecordBtn.disabled = true;
        status.textContent = "Uploading...";

        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const timestamp = Date.now();
        const fileName = `${candidateName.replace(/\s+/g, "_")}_${timestamp}.webm`;

        console.log("üì§ Uploading file:", fileName, "size:", blob.size);

        const { data, error } = await supabase.storage.from(bucketName).upload(fileName, blob);

        console.log("üì¶ Supabase upload result:", data, error);
        if (error) {
          status.textContent = "Upload failed. Please try again.";
          console.error("‚ùå Upload error:", error);
        } else {
          const { data: downloadData } = supabase.storage.from(bucketName).getPublicUrl(fileName);
          status.innerHTML = `Upload complete!<br><a href="${downloadData.publicUrl}" target="_blank">View Video</a>`;
          console.log("‚úÖ Video URL:", downloadData.publicUrl);

          emailjs.send('service_30hprhm', 'template_9kwjzrd', {
            candidate_name: candidateName,
            candidate_email: candidateEmail,
            video_url: downloadData.publicUrl
          }).then(function(response) {
            console.log('‚úÖ Email sent:', response.status, response.text);
          }, function(error) {
            console.error('‚ùå Email error:', error);
          });
        }
      });
    </script>
  </div>
</body>
</html>
