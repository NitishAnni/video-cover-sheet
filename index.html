<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Cover Sheet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #f5f5f5;
      margin: 0;
    }
    .container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      max-width: 700px;
      width: 100%;
    }
    h2 { text-align: center; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    video {
      width: 100%;
      margin-top: 15px;
      border-radius: 10px;
      background: #000;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #007BFF;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Video Cover Sheet</h2>

    <label for="name">Full Name</label>
    <input type="text" id="name" placeholder="Enter your name"/>

    <label for="email">Email</label>
    <input type="email" id="email" placeholder="Enter your email"/>

    <label>Question 1: Tell us about yourself</label>
    <label>Question 2: Why are you applying for this role?</label>
    <label>Question 3: What makes you a good fit?</label>

    <video id="video" autoplay muted></video>

    <div class="buttons">
      <button id="startBtn">Start Recording</button>
      <button id="stopBtn" disabled>Stop Recording</button>
      <button id="reRecordBtn" disabled>Re-record</button>
    </div>
  </div>

  <!-- Supabase and EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.6.0/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script>
    window.onload = () => {
      // Initialize Supabase
      const SUPABASE_URL = "https://rxwdqmfeeknxshbydsne.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4d2RxbWZlZWtueHNoYnlkc25lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNDMyNTksImV4cCI6MjA3MzcxOTI1OX0.sP8DJzwLrC4tJ8JJjVhBUKitVsXsiNFYnsj0jLdlD2U";
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Initialize EmailJS
      emailjs.init("_rmD1hNEDk-sVx2TQ");

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const reRecordBtn = document.getElementById("reRecordBtn");
      const video = document.getElementById("video");
      const nameInput = document.getElementById("name");
      const emailInput = document.getElementById("email");

      let mediaRecorder;
      let recordedChunks = [];
      let stream;

      async function initCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          video.srcObject = stream;
        } catch (err) {
          alert("Camera/Mic access denied: " + err.message);
        }
      }

      async function startRecording() {
        if (!nameInput.value || !emailInput.value) {
          alert("Please enter your name and email before recording.");
          return;
        }
        if (!stream) await initCamera();

        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = uploadRecording;

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        reRecordBtn.disabled = true;
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          stopBtn.disabled = true;
        }
      }

      async function uploadRecording() {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        const fileName = `${Date.now()}_${nameInput.value.replace(/\s+/g,"_")}.webm`;

        const { data, error } = await supabaseClient.storage
          .from("video_cover_sheet")
          .upload(fileName, blob, { contentType: "video/webm" });

        if (error) {
          alert("Upload failed: " + error.message);
          console.error(error);
          return;
        }

        const { data: publicData } = supabaseClient.storage
          .from("video_cover_sheet")
          .getPublicUrl(fileName);

        const publicUrl = publicData.publicUrl;
        console.log("Uploaded video URL:", publicUrl);

        // Send Email
        emailjs.send("service_30hprhm", "template_9kwjzrd", {
          from_name: nameInput.value,
          from_email: emailInput.value,
          message: "New video submitted",
          video_url: publicUrl
        }).then(() => {
          alert("Recording uploaded and email sent successfully!");
        }).catch(err => {
          alert("Email send failed: " + err.message);
        });

        reRecordBtn.disabled = false;
      }

      function reRecord() {
        startBtn.disabled = false;
        reRecordBtn.disabled = true;
      }

      startBtn.addEventListener("click", startRecording);
      stopBtn.addEventListener("click", stopRecording);
      reRecordBtn.addEventListener("click", reRecord);

      // Initialize camera preview
      initCamera();
    };
  </script>
</body>
</html>
